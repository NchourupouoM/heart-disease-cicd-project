name: CI/CD Pipeline for Heart Disease Model

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # MODIFIÉ : Installation des dépendances (incluant pdoc)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Train model
        run: python scripts/train.py

      - name: Evaluate model
        id: evaluate
        run: |
          python scripts/evaluate.py
          SCORE=$(jq .accuracy metrics/metrics.json)
          echo "score=$SCORE" >> $GITHUB_OUTPUT

      - name: Check score against threshold
        id: check_score
        run: |
          SCORE=${{ steps.evaluate.outputs.score }}
          THRESHOLD=${{ secrets.THRESHOLD_SCORE }}
          echo "Model Score: $SCORE"
          echo "Threshold: $THRESHOLD"
          if $(awk -v score="$SCORE" -v threshold="$THRESHOLD" 'BEGIN {exit !(score >= threshold)}'); then
            echo "✅ Score is above threshold. Proceeding to deployment."
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Score is below threshold. Deployment skipped."
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi
          
      # --- BLOC DE DÉPLOIEMENT ---
      - name: Deploy to Hugging Face Hub
        if: steps.check_score.outputs.deploy == 'true'
        env:
          HF_API_KEY: ${{ secrets.HF_API_KEY }}
        run: python scripts/deploy.py
      
      # --- BLOC DE GÉNÉRATION DU SITE ---
        
      # MODIFIÉ : Ajout d'un lien vers la doc
      - name: Generate static site for results (Deployment Case)
        if: steps.check_score.outputs.deploy == 'true'
        run: |
          mkdir -p site
          echo "<html><body>" > site/index.html
          echo "<h1>Résultats du Modèle de Prédiction Cardiaque</h1>" >> site/index.html
          echo "<h2>Statut : DÉPLOYÉ AVEC SUCCÈS</h2>" >> site/index.html
          echo "<p>Dernière mise à jour : $(date)</p>" >> site/index.html
          echo "<h3>Score d'Accuracy : ${{ steps.evaluate.outputs.score }} (Seuil : ${{ secrets.THRESHOLD_SCORE }})</h3>" >> site/index.html
          echo "<p>Le modèle a été déployé car le score est supérieur ou égal au seuil.</p>" >> site/index.html
          echo "<p>Lien vers le modèle sur Hugging Face : <a href='https://huggingface.co/NchourupouoM/heart-disease-classifier'>Voir le modèle</a></p>" >> site/index.html
          echo "<p><a href='docs/index.html'>Voir la documentation technique du projet</a></p>" >> site/index.html
          echo "</body></html>" >> site/index.html

      # MODIFIÉ : Ajout d'un lien vers la doc
      - name: Generate static site for results (Non-Deployment Case)
        if: steps.check_score.outputs.deploy == 'false'
        run: |
          mkdir -p site
          echo "<html><body>" > site/index.html
          echo "<h1>Résultats du Modèle de Prédiction Cardiaque</h1>" >> site/index.html
          echo "<h2>Statut : DÉPLOIEMENT REFUSÉ</h2>" >> site/index.html
          echo "<p>Dernière mise à jour : $(date)</p>" >> site/index.html
          echo "<h3>Score d'Accuracy : ${{ steps.evaluate.outputs.score }} (Seuil Requis : ${{ secrets.THRESHOLD_SCORE }})</h3>" >> site/index.html
          echo "<p>Le modèle n'a pas été déployé car le score est inférieur au seuil requis.</p>" >> site/index.html
          echo "<p><a href='docs/index.html'>Voir la documentation technique du projet</a></p>" >> site/index.html
          echo "</body></html>" >> site/index.html
      
      # NOUVELLE ÉTAPE : Générer la documentation technique avec pdoc
      - name: Generate Technical Documentation
        if: success()
        run: |
          # Génère la doc HTML pour le module 'scripts' et la place dans 'site/docs'
          pdoc --html scripts -o site/docs
          
      - name: Deploy to GitHub Pages
        if: success()
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: site # Déploie le dossier 'site' entier (contenant l'index et le sous-dossier /docs)
          
      # --- BLOC DE NOTIFICATIONS (INCHANGÉ) ---
      # ... (toutes les étapes d'envoi d'email restent ici)

      - name: Send success email notification (Deployment)
        if: success() && steps.check_score.outputs.deploy == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "✅ [SUCCÈS] Déploiement du modèle Heart Disease"
          body: |
            Bonjour,
            Le modèle de classification des maladies cardiaques a été validé et déployé avec succès.
            Score d'accuracy obtenu : ${{ steps.evaluate.outputs.score }} (Seuil : ${{ secrets.THRESHOLD_SCORE }})
            Commit par : ${{ github.actor }}
            Lien vers les logs du workflow : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.ADMIN_EMAIL }},${{ github.event.pusher.email }}
          from: GitHub Actions Notifier <${{ secrets.SMTP_USER }}>

      - name: Send failure email notification (Low Score)
        if: success() && steps.check_score.outputs.deploy == 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "ℹ️ [INFO] Non-déploiement du modèle Heart Disease (Score trop bas)"
          body: |
            Bonjour,
            La validation du modèle de classification des maladies cardiaques a réussi, mais le score est trop bas pour un déploiement.
            Score d'accuracy obtenu : ${{ steps.evaluate.outputs.score }} (Seuil requis : ${{ secrets.THRESHOLD_SCORE }})
            Le déploiement a été annulé. Aucune action n'est requise, sauf si une amélioration du modèle est souhaitée.
            Commit par : ${{ github.actor }}
            Lien vers les logs du workflow : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.ADMIN_EMAIL }},${{ github.event.pusher.email }}
          from: GitHub Actions Notifier <${{ secrets.SMTP_USER }}>

      - name: Send failure email notification (Job Failed)
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "❌ [ÉCHEC] Le workflow CI/CD a échoué"
          body: |
            Bonjour,
            Le workflow pour le modèle Heart Disease a échoué en raison d'une erreur.
            Merci de consulter les logs pour diagnostiquer le problème.
            Commit par : ${{ github.actor }}
            Lien vers les logs du workflow : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.ADMIN_EMAIL }},${{ github.event.pusher.email }}
          from: GitHub Actions Notifier <${{ secrets.SMTP_USER }}>